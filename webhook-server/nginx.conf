events {
        worker_connections 1024;
}

http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log debug;

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types
                text/plain
                text/css
                text/xml
                text/javascript
                application/json
                application/xml+rss
                application/atom+xml
                image/svg+xml;

        # Rate limiting for webhook endpoints
        limit_req_zone $binary_remote_addr zone=webhook_limit:10m rate=10r/m;

        upstream sveltekit {
                server sveltekit-app:3000;
        }

        upstream backend {
                server app:8080;
        }

        # MD TalkMan Webhook Server
        upstream webhook_backend {
                server webhook-server:8080;
        }

        server {
                listen 80;
                listen [::]:80;
                server_name localhost _;

                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-XSS-Protection "1; mode=block" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header Referrer-Policy "no-referrer-when-downgrade" always;

                # MD TalkMan Webhook endpoints - GitHub webhook handling
                location /webhook/ {
                        limit_req zone=webhook_limit burst=5 nodelay;
                        
                        proxy_pass http://webhook_backend;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                        
                        # GitHub webhook specific headers
                        proxy_set_header X-Hub-Signature-256 $http_x_hub_signature_256;
                        proxy_set_header X-GitHub-Event $http_x_github_event;
                        proxy_set_header X-GitHub-Delivery $http_x_github_delivery;
                        
                        # Timeout settings for webhooks
                        proxy_connect_timeout 10s;
                        proxy_send_timeout 30s;
                        proxy_read_timeout 30s;
                        
                        # Disable buffering for real-time webhook processing
                        proxy_buffering off;
                }

                location /api {
                        rewrite ^/api(.*)$ $1 break;
                        proxy_pass http://backend;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;

                        proxy_connect_timeout 60s;
                        proxy_send_timeout 60s;
                        proxy_read_timeout 60s;

                        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
                        proxy_next_upstream_tries 1;
                        proxy_next_upstream_timeout 60s;

                        proxy_buffering on;
                        proxy_buffer_size 4k;
                        proxy_buffers 8 4k;
                }

                location ~ /api/proj/(.+) {
                        rewrite ^/api/proj/(.+)$ /proj/$1 break;
                        proxy_pass http://backend;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;

                        proxy_connect_timeout 60s;
                        proxy_send_timeout 60s;
                        proxy_read_timeout 60s;

                        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
                        proxy_next_upstream_tries 1;
                        proxy_next_upstream_timeout 60s;

                        proxy_buffering on;
                        proxy_buffer_size 4k;
                        proxy_buffers 8 4k;
                }

                location = /api/proj {
                        rewrite ^/api/proj$ /proj/ break;
                        proxy_pass http://backend;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;

                        proxy_connect_timeout 60s;
                        proxy_send_timeout 60s;
                        proxy_read_timeout 60s;

                        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
                        proxy_next_upstream_tries 1;
                        proxy_next_upstream_timeout 60s;

                        proxy_buffering on;
                        proxy_buffer_size 4k;
                        proxy_buffers 8 4k;
                }

                location / {
                        proxy_pass http://sveltekit;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;

                        proxy_set_header X-Forwarded-Host $host;
                        proxy_set_header X-Forwarded-Server $host;
                        proxy_redirect off;

                        proxy_connect_timeout 60s;
                        proxy_send_timeout 60s;
                        proxy_read_timeout 60s;

                }

                location /_app/immutable/ {
                        proxy_pass http://sveltekit;
                        proxy_cache_valid 200 1y;
                        add_header Cache-Control "public, immutable";
                }

                location /health {
                        access_log off;
                        return 200 "healthy \n";
                        add_header Content-Type text/plain;
                }

                error_page 500 502 503 504 /50x.html;
                location = /50x.html {
                        root /usr/share/nginx/html;
                }
        }
}